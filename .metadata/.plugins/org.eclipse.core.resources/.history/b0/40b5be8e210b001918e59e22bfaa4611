package pruebas;

import static org.junit.Assert.assertTrue;
import org.junit.Before;
import org.junit.Test;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.Persistence;
import javax.persistence.Query;

import jpa.eclipselink.modelo.Familia;
import jpa.eclipselink.modelo.Persona;

public class JpaTest {
	
	private static final String PERSISTENCE_UNIT_NAME = "relaciones_persistentes";
	private EntityManagerFactory factoria;
	
	@Before
	public void setUp() throws Exception {
		factoria = Persistence.createEntityManagerFactory(PERSISTENCE_UNIT_NAME);
		EntityManager em = factoria.createEntityManager();
		// Comenzar una nueva transaccion local de tal forma que pueda persistir
		//como una nueva entidad.
		// Leer las entradas que ya hay en la base de datos.
		// Las personas no deben tener ningun atributo asignado todavia
		Query q = em.createQuery("select m from Persona m");
		// Comprobar si necesitamos crear entradas en la base
		boolean crearseNuevasEntradas = (q.getResultList().size() == 0);
		if (crearseNuevasEntradas){
			// Vamos a ello...
			assertTrue(q.getResultList().size() == 0);
			Familia familia = new Familia();
			familia.setDescripcion("Familia Martinez");
			em.persist(familia);
			for (int i = 0; i < 20; i++) {
				//Crearse una "persona" y asignar sus atributos con: setNombre(...) y setApellidos(...)
				em.persist(persona);
				//anadir "persona" al ListArray<Persona> que representa a "familia"
				// ahora hacemos que persista la relacion familia-persona
				em.persist(persona);
				em.persist(familia);
			}
		}
		// Ahora hay que hacer "commit" de la transaccion, lo que causa que la
		//entidad se salve en la base de datos.
		em.getTransaction().commit();
		//Ahora hay que cerrar el EntityManager o perderemos nuestras entradas.
		em.close();
	}//setUp()